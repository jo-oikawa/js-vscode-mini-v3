<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VS Code-ish</title>
  
  <!-- 
    SUSTAINABILITY NOTE:
    For production, use official Codicons from CDN or self-hosted:
    
    Option 1 (CDN - Most Sustainable):
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@vscode/codicons@0.0.36/dist/codicon.css">
    
    Option 2 (Self-Hosted - Recommended for restricted networks):
    Download from: https://github.com/microsoft/vscode-codicons/releases
    Include: codicon.css + codicon.ttf in your project
    
    This file uses embedded SVGs for zero dependencies but is limited to ~25 icons.
    Codicons has 400+ icons and is actively maintained by Microsoft.
  -->
  <!-- Use official Codicons from CDN to ensure correct glyph mappings -->
  <link rel="stylesheet" href="./assets/codicons/codicon.css" />
  
  <style>
    *, *::before, *::after {
      box-sizing: border-box;
    }
    
    .icon {
      width: 16px;
      height: 16px;
      display: inline-block;
      vertical-align: middle;
      fill: currentColor;
      flex-shrink: 0;
      overflow: visible;
    }
    .icon-lg { 
      width: 20px; 
      height: 20px; 
      flex-shrink: 0;
      overflow: visible;
    }
    
    :root{
      --bg: #1e1e1e;
      --fg: #d4d4d4;
      --muted: #9aa0a6;
      --border: #2a2a2a;
      --shadow: rgba(0,0,0,.35);

      --titlebar-bg:#1f1f1f;
      --activity-bg:#252526;
      --sidebar-bg:#252526;
      --editor-bg:#1e1e1e;
      --panel-bg:#1b1b1b;
      --status-bg:#007acc;

      --accent:#007acc;
      --accent-2:#3794ff;
      --danger:#f44747;

      --tab-bg:#2d2d2d;
      --tab-active-bg:#1e1e1e;

      /* Extended theming hooks */
      --border-strong:#2a2a2a;
      --tab-fg:#ffffff;
      --tab-inactive-fg:#d4d4d4;
      --editor-fg:#d4d4d4;
      --titlebar-fg:#cccccc;
      --activity-fg:#cccccc;
      --sidebar-fg:#d4d4d4;
      --panel-fg:#d4d4d4;

      --font-ui: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;

      --fs-ui: 12px;
      --fs-code: 13px;
      --lh-code: 1.6;

      --activity-w: 48px;
      --sidebar-w: 280px;
      --titlebar-h: 34px;
      --statusbar-h: 22px;

      /* Panel sizing (terminal) */
      --panel-h: 260px;
      --splitter-h: 1px;
    }

    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--fg); font-family: var(--font-ui); font-size: var(--fs-ui); }
    .workbench {
      height: 100%;
      display: grid;
      grid-template-rows: var(--titlebar-h) 1fr var(--statusbar-h);
    }

    /* Codicon fallback control */
    .codicon {
      display: inline-block;
      font: normal normal normal 16px/1 codicon;
      vertical-align: middle;
      width: 16px;
      height: 16px;
    }
    .codicon.codicon-lg { font-size: 20px; width: 20px; height: 20px; }
    /* Always prefer Codicons; suppress any legacy SVG fallbacks */
    .fallback-icon { display: none !important; }

    /* Seti file icon font (VS Code file icons) */
    @font-face {
      font-family: "seti";
      src: url("./assets/seti-theme-icons/seti.woff") format("woff");
      font-weight: normal;
      font-style: normal;
      font-display: swap;
    }
    .file-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      line-height: 1;
      flex: 0 0 16px;
      user-select: none;
    }
    .file-icon.seti {
      font-family: "seti";
      font-size: 24px; /* Seti theme uses 150% of 16px base */
      line-height: 1;
      /* Seti glyphs look a bit high; optically center */
      transform: translateY(0.5px);
    }
    /* Ensure Seti icon colors override parent element colors - inline styles have highest specificity */

    .titlebar {
      background: var(--titlebar-bg);
      border-bottom: 1px solid var(--border);
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      padding: 0 10px;
      gap: 10px;
      user-select: none;
    }

    .title-left { display: flex; align-items: center; gap: 10px; min-width: 0; }
    .title-center { justify-self: center; display: flex; align-items: center; gap: 6px; }
    .window-dots { display: flex; gap: 6px; }
    .dot { width: 10px; height: 10px; border-radius: 999px; background: #555; }
    .dot.red { background: #ff5f57; }
    .dot.yellow { background: #febc2e; }
    .dot.green { background: #28c840; }
    .title { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--titlebar-fg, var(--muted)); }
    .title-actions { display: flex; gap: 6px; align-items: center; }
    .titlebar .btn { color: var(--titlebar-fg, var(--fg)); }

    /* Command Center (project quick palette) */
    .project-quick {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 4px 10px;
      border-radius: 6px;
      border: 1px solid var(--border, #2a2a2a);
      background: var(--command-bg, rgba(255,255,255,0.02));
      color: var(--titlebar-fg, var(--fg));
      cursor: pointer;
      min-width: 200px;
      max-width: 40vw;
      overflow: hidden;
      white-space: nowrap;
    }
    .project-quick:hover { background: rgba(255,255,255,.06); }
    .project-quick .label {
      overflow: hidden; text-overflow: ellipsis;
    }

    /* Chat menu popover */
    .menu-wrap { position: relative; }
    .menu {
      position: absolute;
      top: 28px;
      right: 0;
      background: var(--menu-bg, #1f1f1f);
      border: 1px solid var(--border, #2a2a2a);
      border-radius: 8px;
      min-width: 220px;
      box-shadow: 0 12px 32px rgba(0,0,0,.4);
      display: none;
      z-index: 60;
      overflow: hidden;
    }
    .menu.show { display: block; }
    .menu .item { padding: 8px 12px; cursor: pointer; display:flex; align-items:center; gap:8px; }
    .menu .item:hover { background: rgba(255,255,255,.06); }

    /* Standalone Chat Window (modal) */
    .chat-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 80;
    }
    .chat-overlay.show { display: flex; }
    .chat-window {
      width: min(960px, 92vw);
      height: min(78vh, 820px);
      background: var(--chatwin-bg, #1f1f1f);
      color: var(--chatwin-fg, var(--fg));
      border: 1px solid var(--border, #2a2a2a);
      border-radius: 12px;
      display: grid;
      grid-template-rows: 44px 1fr auto;
      overflow: hidden;
      box-shadow: 0 18px 64px rgba(0,0,0,.6);
    }
    .chat-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 8px 12px;
      border-bottom: 1px solid var(--border, #2a2a2a);
      background: var(--titlebar-bg, #1f1f1f);
      color: var(--titlebar-fg, var(--fg));
      font-weight: 600;
    }
    .chat-body {
      position: relative;
      overflow: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .chat-empty-state {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      color: var(--muted);
      padding: 40px 0;
      gap: 8px;
      min-height: 100%;
    }
    .aux-empty-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .chat-empty-state.visible {
      display: flex;
    }
    .aux-empty-icon {
      width: 96px;
      height: 96px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .aux-empty-icon i {
      font-size: 28px;
      color: var(--muted);
      transform: scale(4);
      transform-origin: center;
    }
    .aux-empty-copy {
      max-width: 180px;
      font-size: 13px;
    }
    .chat-empty { margin: auto; text-align: center; color: var(--muted); }
    .chat-empty .codicon { font-size: 28px; display:block; margin: 0 auto 10px; }
    .chat-bubble { max-width: 75%; padding: 10px 12px; border-radius: 10px; }
    .chat-bubble.user { align-self: flex-end; background: rgba(0,122,204,.18); border:1px solid rgba(0,122,204,.25); }
    .chat-bubble.bot { align-self: flex-start; background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08); }
    .chat-composer {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px;
      border-top: 1px solid var(--border, #2a2a2a);
      background: var(--panel-bg, #1b1b1b);
    }
    .aux-chat-bar {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border: none;
      background: var(--panel-bg, #1b1b1b);
    }
    .chat-composer .copilot-pill,
    .aux-chat-bar .copilot-pill {
      width: 34px;
      height: 34px;
      border-radius: 6px;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--muted);
      font-size: 18px;
      border: none;
      box-shadow: none;
    }
    .copilot-pill.copilot-active {
      color: var(--accent) !important;
    }
    .dropdown-wrap {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      position: relative;
    }
    .dropdown-wrap select {
      background: transparent;
      border: none;
      color: var(--fg);
      font-size: 13px;
      font-family: var(--font-ui);
      padding: 4px 0;
      appearance: none;
      cursor: pointer;
      max-width: 110px;
      border-bottom: 1px solid transparent;
      transition: border-color 0.2s ease;
    }
    .dropdown-wrap:hover select,
    .dropdown-wrap:focus-within select {
      border-bottom-color: var(--accent);
      outline: none;
    }
    .dropdown-wrap i {
      font-size: 12px;
      color: var(--muted);
      flex-shrink: 0;
    }
    .dropdown-wrap select::-ms-expand { display: none; }
    .chat-composer input {
      flex: 1;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.08);
      color: var(--fg);
      border-radius: 8px;
      padding: 8px 12px;
      outline: none;
      font-family: var(--font-ui);
      font-size: 13px;
    }

    /* Updates modal */
    .updates-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      display: none;
      z-index: 90;
    }
    .updates-overlay.show { display: block; }
    .updates-modal {
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      width: 33.333vw;
      min-width: 360px;
      max-width: 560px;
      background: var(--editor-bg);
      color: var(--fg);
      display: grid;
      grid-template-rows: 44px 1fr;
      border-left: 1px solid var(--border);
    }
    .updates-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 12px;
      border-bottom: 1px solid var(--border);
      background: var(--titlebar-bg);
    }
    .updates-title {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
    }
    .updates-title .vscode-mark { width: 18px; height: 18px; display: block; }
    .updates-body {
      padding: 18px 22px;
      overflow: auto;
    }
    .updates-body h1 { font-size: 20px; margin: 0 0 10px; }
    .updates-body h2 { font-size: 16px; margin: 18px 0 8px; }
    .updates-body p { margin: 8px 0; color: var(--fg); }
    .updates-body a { color: var(--accent); text-decoration: none; }
    .updates-body a:hover { text-decoration: underline; }
    .updates-body img { max-width: 100%; height: auto; border-radius: 10px; border: 1px solid rgba(255,255,255,.10); margin: 12px 0; display:block; }
    .updates-body ul { margin: 8px 0 8px 18px; padding: 0; }
    .updates-body li { margin: 4px 0; }
    .updates-body pre {
      margin: 12px 0;
      padding: 12px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 10px;
      overflow: auto;
      font-family: var(--font-mono);
      font-size: 12px;
      line-height: 1.5;
    }
    .updates-body code { font-family: var(--font-mono); }
    .btn {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--fg);
      padding: 4px 8px;
      border-radius: 6px;
      cursor: pointer;
      font-size: var(--fs-ui);
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .btn:hover { border-color: #3a3a3a; }
    .btn.primary { border-color: var(--accent); color: #cfeaff; }
    .btn.icon { width: 28px; height: 26px; justify-content: center; padding: 0; }
    .btn.hidden { display: none; }
    .btn.plain { border: 0; }
    .btn.plain:hover { border: 0; }
    .btn.plain:focus, .btn.plain:focus-visible { outline: none; box-shadow: none; }

    .updates-btn { position: relative; }
    .updates-btn .vscode-mark {
      width: 16px;
      height: 16px;
      display: block;
    }
    .updates-dot {
      position: absolute;
      right: 2px;
      top: 2px;
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #3bd671;
      box-shadow: 0 0 0 2px var(--titlebar-bg);
      animation: updatesBlink 1.2s ease-in-out infinite;
    }
    @keyframes updatesBlink {
      0%, 55%, 100% { opacity: 1; }
      70% { opacity: 0.2; }
    }

    .main {
      display: grid;
      grid-template-columns: var(--activity-w) var(--sidebar-w) minmax(0,1fr) var(--aux-divider-w) var(--auxiliary-w);
      /* Critical: give the grid a definite row size so `.content` can size its 1fr tracks
         even when the editor is "empty" (absolute-positioned empty state has no intrinsic height). */
      grid-template-rows: minmax(0, 1fr);
      height: 100%;
      min-height: 0;
      min-width: 0;
      gap: 0;
    }
    /* Pin children to fixed columns so hiding sidebar doesn't shift placement */
    .main > .activitybar { grid-column: 1; }
    .main > .sidebar { grid-column: 2; }
    .main > .content { grid-column: 3; }
    .main > .resizer-x { grid-column: 4; }
    .main > .auxiliarybar { grid-column: 5; }

    :root { --auxiliary-w: 360px; --aux-divider-w: 4px; }

    .activitybar {
      background: var(--activity-bg);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 8px 0;
      gap: 8px;
      user-select: none;
    }
    .act {
      width: 34px; height: 34px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--activity-fg, var(--muted));
      cursor: pointer;
      overflow: visible;
      position: relative;
      border-radius: 0;
    }
    .act .icon-lg { margin: 0 2px; }
    .act.active {
      color: var(--activity-active-fg, #fff);
      background: transparent;
    }
    .act.active::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: var(--accent);
    }
    .act:hover { background: rgba(255,255,255,.05); color: var(--activity-active-fg, #fff); }

    .sidebar {
      background: var(--sidebar-bg);
      border-right: 1px solid var(--border);
      min-height: 0;
      min-width: 0;
      display: grid;
      grid-template-rows: auto 1fr;
      overflow: visible;
    }
    .sidebar-header {
      padding: 10px 10px 8px;
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
      user-select: none;
    }
    .sidebar-title { letter-spacing: .06em; color: var(--muted); font-weight: 600; font-size: 11px; }
    .sidebar-body { padding: 8px; overflow-x: visible; overflow-y: auto; }

    .tree { font-family: var(--font-ui); font-size: var(--fs-ui); line-height: 1.8; }
    .tree .item {
      display: flex; gap: 8px; align-items: center;
      padding: 4px 8px; border-radius: 6px; cursor: pointer;
      color: var(--sidebar-fg, var(--fg));
      overflow: visible;
    }
    .tree .item:hover { background: var(--list-hover-bg, rgba(255,255,255,.05)); }
    .tree .item.active { 
      background: var(--list-activeSelection-bg, rgba(0,122,204,.18)); 
      outline: 1px solid var(--list-activeSelection-border, rgba(0,122,204,.25)); 
      color: var(--list-activeSelection-fg, inherit);
    }
    .tree .item .icon { flex-shrink: 0; margin: 0 2px; }

    .content {
      min-height: 0;
      min-width: 0;
      display: grid;
      grid-template-rows: auto 1fr var(--splitter-h) var(--panel-h);
      background: var(--editor-bg);
    }
    /* Pin content children to fixed rows so hiding tabs doesn't reflow editor/panel rows */
    .content > .tabs { grid-row: 1; }
    .content > .editor-wrap { grid-row: 2; }
    .content > .panel-resizer { grid-row: 3; }
    .content > .panel { grid-row: 4; }
    /* If no file is open: keep editor area visible and keep terminal at a stable height (not 50/50). */
    :root { --panel-empty-h: 260px; }
    .content.no-file { 
      grid-template-rows: 0px minmax(200px, 1fr) var(--splitter-h) var(--panel-h); 
    }
    .hide-panel .content.no-file { grid-template-rows: 0px 1fr 0px 0px; }

    /* IMPORTANT: don't `display:none` the tabs in empty mode, or the grid auto-placement
       will move `.editor-wrap` into row 1 (0px) and the panel will take the full height. */
    .content.no-file .tabs {
      min-height: 0;
      height: 0;
      padding: 0;
      border-bottom: 0;
      overflow: hidden;
      background: transparent;
      pointer-events: none;
    }
    .content.no-file .tabs > * { display: none; }
    .content.no-file .gutter { display: none; }

    .panel-resizer {
      height: var(--splitter-h);
      background: var(--border);
      cursor: row-resize;
      user-select: none;
    }
    .hide-panel .panel-resizer { display: none !important; }

    .tabs {
      display: flex; gap: 1px;
      background: var(--border);
      border-bottom: 1px solid var(--border);
      user-select: none;
      overflow-x: auto;
      min-height: 34px;
      align-items: stretch;
    }
    .tab {
      background: var(--tab-bg);
      padding: 6px 10px;
      display: flex; align-items: center; gap: 8px;
      cursor: pointer;
      min-width: 120px;
      max-width: 260px;
      flex-shrink: 0;
      overflow: visible;
      height: 34px;
      color: var(--tab-inactive-fg, var(--fg));
    }
    .tab:hover { background: rgba(255,255,255,.05); }
    .tab.active { background: var(--tab-active-bg); border-bottom: 2px solid var(--accent); color: var(--tab-fg, #fff); }
    .tab .name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .tab .icon { flex-shrink: 0; margin: 0 2px; }
    .tab .close { margin-left:auto; opacity:.7; }
    .tab:hover .close { opacity: 1; }
    .dot-unsaved { width: 7px; height: 7px; border-radius: 999px; background: var(--accent-2); flex-shrink: 0; margin: 0 2px; }

    .editor-wrap {
      position: relative;
      min-height: 0;
      min-width: 0;
      display: grid;
      grid-template-columns: 52px 1fr;
      overflow: hidden;
    }
    /* When empty, ensure editor-wrap maintains height and empty state fills it */
    .content.no-file .editor-wrap {
      grid-template-columns: 0px 1fr;
      min-height: 200px; /* Ensure minimum visible height */
    }
    .gutter {
      background: #191919;
      border-right: 1px solid var(--border);
      padding: 10px 0;
      font-family: var(--font-mono);
      font-size: var(--fs-code);
      line-height: var(--lh-code);
      color: var(--editorLineNumber-fg, #6b6b6b);
      text-align: right;
      user-select: none;
      overflow: hidden;
    }
    .gutter div { padding: 0 10px; }
    .gutter div.current-line { background: var(--editor-lineHighlight-bg, rgba(255,255,255,.03)); }
    
    .editor {
      position: relative;
      overflow: auto;
      min-width: 0;
      min-height: 0;
      font-family: var(--font-mono);
      font-size: var(--fs-code);
      line-height: var(--lh-code);
    }
    /* Ensure editor maintains height when empty state is shown */
    .content.no-file .editor {
      min-height: 200px;
      height: 100%;
    }
    
    .editor-container { 
      position: relative; 
      min-height: 100%;
      margin: 0;
      padding: 0;
    }
    
    .editor textarea {
      position: absolute;
      inset: 0;
      width: 100%;
      min-height: 100%;
      resize: none;
      border: 0;
      outline: none;
      padding: 10px 12px;
      background: transparent;
      color: transparent;
      caret-color: var(--editor-cursor-fg, #fff);
      font-family: var(--font-mono);
      font-size: var(--fs-code);
      line-height: var(--lh-code);
      white-space: pre;
      overflow: hidden;
      tab-size: 2;
      z-index: 2;
      word-wrap: normal;
      overflow-wrap: normal;
      letter-spacing: 0;
      word-spacing: 0;
      text-rendering: geometricPrecision;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      margin: 0;
      border: none;
      font-variant-ligatures: none;
      font-feature-settings: normal;
    }
    
    .editor textarea::selection { background: var(--editor-selection-bg, rgba(0,122,204,.35)); }
    
    .highlight {
      position: absolute;
      inset: 0;
      padding: 10px 12px;
      white-space: pre;
      pointer-events: none;
      z-index: 1;
      font-family: var(--font-mono);
      font-size: var(--fs-code);
      line-height: var(--lh-code);
      color: var(--editor-fg, var(--fg));
      word-wrap: normal;
      overflow-wrap: normal;
      letter-spacing: 0;
      word-spacing: 0;
      text-rendering: geometricPrecision;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      tab-size: 2;
      margin: 0;
      border: none;
      font-variant-ligatures: none;
      font-feature-settings: normal;
    }
    
    .highlight .line { 
      display: block;
      line-height: var(--lh-code);
      margin: 0;
      padding: 0;
      border: 0;
    }
    .highlight .line.current-line { background: var(--editor-lineHighlight-bg, rgba(255,255,255,.03)); }

    /* Ensure token spans don't add spacing */
    .highlight span {
      display: inline;
      margin: 0;
      padding: 0;
      border: 0;
      font-size: inherit;
      line-height: inherit;
      letter-spacing: inherit;
      word-spacing: inherit;
      text-rendering: inherit;
    }
    
    .tok-k { color: #c586c0; }
    .tok-s { color: #ce9178; }
    .tok-n { color: #b5cea8; }
    .tok-c { color: #6a9955; }
    .tok-f { color: #dcdcaa; }
    .tok-t { color: #4ec9b0; }

    .panel {
      background: var(--panel-bg);
      border-top: 1px solid var(--border);
      min-height: 0;
      display: grid;
      grid-template-rows: 34px 1fr;
    }
    .panel-tabs {
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 8px;
      border-bottom: 1px solid var(--border);
      user-select: none;
    }
    .panel-left { display:flex; gap: 6px; align-items:center; }
    /* VS Code-like panel tabs with underline for active */
    .pill {
      padding: 8px 10px;
      border-radius: 0;
      background: transparent;
      border: 0;
      border-bottom: 2px solid transparent;
      cursor: pointer;
      display: flex; align-items: center; gap: 6px;
      color: var(--muted);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .06em;
      font-weight: 600;
    }
    .pill:hover { color: #fff; background: rgba(255,255,255,.03); }
    .pill.active { border-bottom-color: var(--accent); color: #fff; }

    .terminal {
      font-family: var(--font-mono);
      font-size: 12px;
      line-height: 1.5;
      display: flex;
      flex-direction: column;
      height: 100%;
      padding: 12px;
      gap: 6px;
    }
    .term-output {
      flex: 1;
      overflow: auto;
      min-height: 0;
    }
    .term-line { color: var(--panel-fg, var(--fg)); }
    .term-dim { color: var(--muted); }
    .term-err { color: var(--danger); }
    .term-ok  { color: #89d185; }

    .term-input-line {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      background: rgba(255,255,255,.03);
      border-radius: 6px;
      border: 1px solid rgba(255,255,255,.08);
    }
    .prompt {
      color: #89d185;
      font-family: var(--font-mono);
      font-size: 12px;
      line-height: 1.5;
      flex-shrink: 0;
    }
    .cmd-wrap {
      position: relative;
      flex: 1;
      display: inline-flex;
      align-items: center;
    }
    .cmd {
      width: 100%;
      background: transparent;
      border: 0;
      color: var(--fg);
      padding: 0;
      outline: none;
      font-family: var(--font-mono);
      font-size: 12px;
      line-height: 1.5;
    }
    /* Terminal IntelliSense-style suggest dropdown */
    .suggest {
      position: absolute;
      left: 0;
      right: 0;
      bottom: calc(100% + 8px);
      background: #1f1f1f;
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 8px;
      box-shadow: 0 18px 60px var(--shadow);
      overflow: hidden;
      display: none;
      z-index: 10;
    }
    .suggest.show { display: block; }
    .sug-row {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 10px;
      align-items: center;
      padding: 8px 10px;
      cursor: default;
      border-bottom: 1px solid rgba(255,255,255,.04);
    }
    .sug-row:last-child { border-bottom: 0; }
    .sug-row .sug-icon { color: var(--muted); }
    .sug-row .sug-label { color: var(--fg); font-family: var(--font-mono); }
    .sug-row .sug-desc { color: var(--muted); font-size: 11px; justify-self: end; }
    .sug-row.active { background: rgba(0,122,204,.18); }

    .statusbar {
      background: var(--status-bg);
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      padding: 0 10px;
      color: var(--status-fg, white);
      user-select: none;
    }
    .status-left, .status-right { display:flex; gap: 10px; align-items:center; }
    .status-item { display: flex; align-items: center; gap: 4px; }

    /* Editor empty state */
    .editor-empty {
      position: absolute;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      text-align: center;
      color: var(--muted);
      /* Note: empty state now overlays only the editor region, so no terminal padding needed */
      padding: 0;
      font-family: var(--font-ui);
      z-index: 3;
      background: var(--editor-bg);
    }
    .editor-empty.show { display: flex; }
    .editor-empty .empty-inner {
      opacity: .85;
      width: min(560px, 92%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      gap: 10px;
    }
    .editor-empty .empty-logo {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 0 8px;
      /* Reserve space so the logo can never overlap the hint block */
      min-height: 108px;
    }
    .editor-empty .logo { 
      display: inline-block;
      font-size: 96px; 
      line-height: 1; 
      color: var(--fg);
      opacity: .14; 
      margin: 0;
      /* Override global `.codicon` 16x16 box so the glyph centers correctly at large sizes */
      width: 1em;
      height: 1em;
    }
    .empty-hints {
      margin-top: 6px;
      display: grid;
      gap: 8px;
      font-size: 12px;
      color: var(--muted);
      /* Slightly narrower so labels sit closer to key sequences */
      width: min(420px, 92%);
    }
    .hint-row {
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: 10px;
    }
    .hint-label { text-align: left; }
    .hint-keys { display: inline-flex; gap: 6px; align-items: center; justify-content: flex-end; }
    .empty-hints kbd {
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.14);
      padding: 2px 7px;
      border-radius: 4px;
      font-family: var(--font-mono);
      font-size: 11px;
      line-height: 1.2;
      min-width: 22px;
      text-align: center;
    }

    /* Auxiliary (Chat) Bar */
    .auxiliarybar {
      background: var(--sidebar-bg);
      border-left: 1px solid var(--border);
      display: grid;
      grid-template-rows: auto 1fr auto;
      min-width: 220px;
      /* Allow grid to shrink properly and avoid extra right blank area */
      width: 100%;
      min-width: 0;
      overflow: hidden;
    }
    .aux-header {
      padding: 10px 10px 8px;
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
      user-select: none;
    }
    .aux-title { letter-spacing: .06em; color: var(--muted); font-weight: 600; font-size: 11px; }
    .aux-body { padding: 10px; overflow: auto; display: flex; flex-direction: column; gap: 10px; }
    .aux-input { display: flex; gap: 8px; padding: 10px; border-top: 1px solid var(--border); }
    .aux-input input { flex: 1; background: rgba(255,255,255,.04); border: 1px solid rgba(255,255,255,.08); color: var(--fg); border-radius: 8px; padding: 8px 10px; outline: none; font-family: var(--font-ui); font-size: 12px; }
    .msg { display: inline-flex; max-width: 90%; padding: 8px 10px; border-radius: 8px; }
    .msg.user { align-self: flex-end; background: rgba(0,122,204,.18); border: 1px solid rgba(0,122,204,.25); }
    .msg.bot { align-self: flex-start; background: rgba(255,255,255,.05); border: 1px solid rgba(255,255,255,.08); }
    .resizer-x { width: var(--aux-divider-w); cursor: col-resize; background: transparent; align-self: stretch; }
    .resizer-x:hover { background: rgba(255,255,255,.06); }

    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.35);
      display: none;
      align-items: flex-start;
      justify-content: center;
      padding-top: 60px;
      z-index: 50;
    }
    .overlay.show { display: flex; }
    .palette {
      width: min(860px, calc(100vw - 24px));
      background: #252526;
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 8px;
      box-shadow: 0 18px 60px var(--shadow);
      overflow: hidden;
    }
    .palette input {
      width: 100%;
      border: 0;
      outline: none;
      padding: 12px;
      background: #1f1f1f;
      color: #fff;
      font-family: var(--font-ui);
      font-size: 14px;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .palette-list { max-height: 320px; overflow: auto; }
    .pal-item {
      padding: 10px 12px;
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 10px;
      cursor: pointer;
      border-bottom: 1px solid rgba(255,255,255,.04);
      align-items: center;
    }
    .pal-item:hover, .pal-item.active { background: rgba(0,122,204,.18); }
    .pal-desc { color: var(--muted); font-size: 11px; }
    .pal-kbd { color: var(--muted); font-size: 11px; }

    .hide-activity .activitybar { display: none !important; }
    .hide-activity .main { grid-template-columns: 0px var(--sidebar-w) minmax(0,1fr) var(--aux-divider-w) var(--auxiliary-w); }
    .hide-sidebar .sidebar { display: none !important; }
    .hide-sidebar .main { grid-template-columns: var(--activity-w) 0px minmax(0,1fr) var(--aux-divider-w) var(--auxiliary-w); }
    .hide-activity.hide-sidebar .main { grid-template-columns: 0px 0px minmax(0,1fr) var(--aux-divider-w) var(--auxiliary-w); }
    .hide-panel .panel { display: none !important; }
    .hide-panel .content { grid-template-rows: auto 1fr 0px 0px; }
    .hide-auxiliary .auxiliarybar, .hide-auxiliary .resizer-x { display: none !important; }
    .hide-auxiliary .main { grid-template-columns: var(--activity-w) var(--sidebar-w) minmax(0,1fr) 0px 0px; }
    /* Resolve combined hide states to avoid leftover reserved widths */
    .hide-sidebar.hide-auxiliary .main { grid-template-columns: var(--activity-w) 0px minmax(0,1fr) 0px 0px; }
    .hide-activity.hide-auxiliary .main { grid-template-columns: 0px var(--sidebar-w) minmax(0,1fr) 0px 0px; }
    .hide-activity.hide-sidebar.hide-auxiliary .main { grid-template-columns: 0px 0px minmax(0,1fr) 0px 0px; }
  </style>
</head>
<body>
  <!-- Embedded SVG Icon Library -->
  <svg style="display:none">
    <!-- Official VS Code Logo -->
    <symbol id="icon-vscode" viewBox="-2 -2 20 20">
      <path d="M11.5 0L15 1.5v13L11.5 16 1 10.5v-5L11.5 0zm.5 2.828L4.328 8 12 13.172V2.828zM10 8L3.5 12V4L10 8z"/>
    </symbol>
    
    <symbol id="icon-files" viewBox="-2 -2 20 20">
      <path d="M14.5 2H7.71l-.85-.85L6.51 1h-5l-.5.5v11l.5.5h13l.5-.5v-10zm-.51 10h-12V2h4.49l.35.15.86.86H14v9z"/>
    </symbol>
    
    <symbol id="icon-search" viewBox="-2 -2 20 20">
      <path d="M11.5 7a4.5 4.5 0 1 1-9 0 4.5 4.5 0 0 1 9 0zM7 10.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7zm3.77-.79l4.5 4.5-.7.7-4.5-4.5.7-.7z"/>
    </symbol>
    
    <symbol id="icon-git" viewBox="-2 -2 20 20">
      <path d="M15.85 7.65l-6.5-6.5-.35-.35-.35.35-6.5 6.5-.35.35.35.36 6.5 6.5.35.35.35-.35 6.5-6.5.35-.36-.35-.35zM2.5 8l5.5-5.5L13.5 8 8 13.5 2.5 8z"/>
      <path d="M7.65 11.65L7 11l1.65-1.65-1.3-1.3L6 9.4 4.35 7.75l.7-.7L6.4 8.4 7.7 7.1 6.4 5.75l.7-.7L8.4 6.4 9.7 5.1l.7.7-1.3 1.3 1.65 1.65-.7.7L9 8.1 7.65 9.4l1.3 1.3-.7.7L6.95 10z"/>
    </symbol>
    
    <symbol id="icon-debug" viewBox="-2 -2 20 20">
      <path d="M8 1l7 3.5-7 3.5-7-3.5L8 1zm6 5.96L8 10.46l-6-3.5V9l6 3.5L14 9V6.96zM2 10.46L8 13.96l6-3.5V13l-6 2-6-2v-2.54z"/>
    </symbol>
    
    <symbol id="icon-extensions" viewBox="-2 -2 20 20">
      <path d="M13 13h-2v-2h2v2zm-2-9V1.5l-.5-.5h-9l-.5.5v13l.5.5h9l.5-.5V12h-1v2H2V2h8v2h1zM9 4l1.35 1H13v1.5L14.5 8 13 9.5V11h-2.65L9 12H7.5L6 10.5 4.5 12H3V9.5L1.5 8 3 6.5V5h2.65L7 4h2z"/>
    </symbol>
    
    <symbol id="icon-settings" viewBox="-2 -2 20 20">
      <path d="M9.1 4.4L8.6 2H7.4l-.5 2.4-.7.3-2-1.3-.9.8 1.3 2-.3.7-2.4.5v1.2l2.4.5.3.7-1.3 2 .8.9 2-1.3.7.3.5 2.4h1.2l.5-2.4.7-.3 2 1.3.9-.8-1.3-2 .3-.7 2.4-.5V7.4l-2.4-.5-.3-.7 1.3-2-.8-.9-2 1.3-.7-.3zM9.4 1l.5 2.4L12 2.1l2 2-1.4 2.1 2.4.4v2.8l-2.4.4L14 11.9l-2 2-2.1-1.4-.4 2.4H6.7l-.4-2.4L4.2 14l-2-2 1.4-2.1L1.2 9.5V6.7l2.4-.4L2.2 4.2l2-2 2.1 1.4.4-2.4h2.7zm-1.5 9.5c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0-5c1.7 0 3 1.3 3 3s-1.3 3-3 3-3-1.3-3-3 1.3-3 3-3z"/>
    </symbol>
    
    <symbol id="icon-close" viewBox="-2 -2 20 20">
      <path d="M8 8.707l3.646 3.647.708-.707L8.707 8l3.647-3.646-.707-.708L8 7.293 4.354 3.646l-.707.708L7.293 8l-3.646 3.646.707.708L8 8.707z"/>
    </symbol>
    
    <symbol id="icon-file" viewBox="-2 -2 20 20">
      <path d="M13.5 2h-8l-.5.5v11l.5.5h9l.5-.5v-8l-1-1zm-.5 10h-8V3h6.5l1.5 1.5v7.5z"/>
    </symbol>
    
    <symbol id="icon-file-code" viewBox="-2 -2 20 20">
      <path d="M13.5 2h-8l-.5.5v11l.5.5h9l.5-.5v-8l-1-1zm-.5 10h-8V3h6.5l1.5 1.5v7.5z"/>
      <path d="M9.08 10.42L8.37 11l2.46 2H9.42l-2.29-2L9.42 9h1.41l-1.75 1.42zM5.58 11h1.41l2.29-2-2.29-2H5.58l1.75 1.58L5.58 11z"/>
    </symbol>
    
    <symbol id="icon-json" viewBox="-2 -2 20 20">
      <path d="M6 2.5V2h-.5L1 2.5v.5l1.5 1.5v2L1 8l1.5 1.5v2L1 13v.5l4.5.5h.5v-.5L4.5 12H4v-2h1V8.5L3.5 7 5 5.5V4h.5V2.5zM10 2.5V2h.5l4.5.5v.5l-1.5 1.5v2L15 8l-1.5 1.5v2L15 13v.5l-4.5.5H10v-.5l1.5-1.5H12v-2h-1V8.5l1.5-1.5L11 5.5V4h-.5V2.5z"/>
    </symbol>
    
    <symbol id="icon-markdown" viewBox="-2 -2 20 20">
      <path d="M1 3.5l.5-.5h13l.5.5v9l-.5.5h-13l-.5-.5v-9zm1 8.5h12V4H2v8zm9-6h1v5h-1V8.2L9 9.8 7 8.2V11H6V6h1l2 1.6L11 6z"/>
    </symbol>
    
    <symbol id="icon-css" viewBox="-2 -2 20 20">
      <path d="M2.5 2.5l.5-.5h10l.5.5 1 11.5-.5.5-5.5 1.5h-.5l-5.5-1.5-.5-.5 1-11.5zm1.577 1.5l-.839 9.596 4.762 1.31 4.762-1.31L13.923 4H4.077z"/>
    </symbol>
    
    <symbol id="icon-terminal" viewBox="-2 -2 20 20">
      <path d="M13.655 3.56L8.918.75a1.785 1.785 0 0 0-1.821 0L2.363 3.56a1.889 1.889 0 0 0-.921 1.628v5.624a1.889 1.889 0 0 0 .913 1.627l4.736 2.812a1.785 1.785 0 0 0 1.822 0l4.736-2.812a1.888 1.888 0 0 0 .913-1.627V5.188a1.889 1.889 0 0 0-.907-1.628zm-3.655 8.44L7 14v-1l3-2-3-2V8l3 2 3-2v1l-3 2 3 2v1z"/>
    </symbol>
    
    <symbol id="icon-warning" viewBox="-2 -2 20 20">
      <path d="M7.56 1h.88l6.54 12.26-.44.74H1.44L1 13.26 7.56 1zM8 2.28L2.28 13H13.7L8 2.28zM8.625 12v-1h-1.25v1h1.25zm-1.25-2V6h1.25v4h-1.25z"/>
    </symbol>
    
    <symbol id="icon-output" viewBox="-2 -2 20 20">
      <path d="M1.5 2h13l.5.5v10l-.5.5h-13l-.5-.5v-10l.5-.5zM2 3v9h12V3H2zm2 6h1v1H4V9zm2 0h1v1H6V9zm2 0h1v1H8V9z"/>
    </symbol>
    
    <symbol id="icon-chevron-right" viewBox="-2 -2 20 20">
      <path d="M6.146 3.854L10.793 8.5l-4.647 4.646-.708-.707L9.793 8.5 5.439 4.561l.707-.707z"/>
    </symbol>
    
    <symbol id="icon-info" viewBox="-2 -2 20 20">
      <path d="M8.568 1.031A6.8 6.8 0 0 1 12.76 3.05a7.06 7.06 0 0 1 .46 9.39 6.85 6.85 0 0 1-8.58 1.74 7 7 0 0 1-3.12-3.5 7.12 7.12 0 0 1-.23-4.71 7 7 0 0 1 2.77-3.79 6.8 6.8 0 0 1 4.508-1.149zM9.04 13.88a5.89 5.89 0 0 0 3.41-2.07 6.07 6.07 0 0 0-.4-8.06 5.82 5.82 0 0 0-7.43-.74 6.06 6.06 0 0 0 .5 10.29 5.81 5.81 0 0 0 3.92.58zM7.375 6h1.25v5h-1.25V6zm0-1.5h1.25v1.25h-1.25V4.5z"/>
    </symbol>
    
    <symbol id="icon-sidebar" viewBox="-2 -2 20 20">
      <path d="M3 3v10h10V3H3zm9 9H7V4h5v8z"/>
    </symbol>
  </svg>

  <div class="workbench" id="wb">
    <div class="titlebar">
      <div class="title-left">
        <div class="window-dots">
          <div class="dot red"></div><div class="dot yellow"></div><div class="dot green"></div>
        </div>
        <svg class="icon fallback-icon" style="width:20px;height:20px"><use href="#icon-vscode"/></svg>
        <div class="title" id="titleText">VS Code-ish</div>
      </div>
      <div class="title-center">
        <div class="project-quick" id="projectQuick" title="Show and Run Commands (Ctrl+Shift+P)" tabindex="0" role="button" aria-label="Project Command Center">
          <i class="codicon codicon-search"></i>
          <span class="label" id="projectName">js-embeddings-1</span>
        </div>
        <div class="menu-wrap">
          <button class="btn icon plain" title="AI Chat" id="btnChatMenu" aria-haspopup="menu" aria-expanded="false">
            <i class="codicon codicon-chat-sparkle"></i>
            <i class="codicon codicon-chevron-down"></i>
        </button>
          <div class="menu" id="chatMenu" role="menu">
            <div class="item" data-action="open-chat" role="menuitem"><i class="codicon codicon-comment-discussion"></i>Open Chat</div>
            <div class="item" data-action="open-inline" role="menuitem"><i class="codicon codicon-comment-unresolved"></i>Open Inline Chat</div>
            <div class="item" data-action="open-quick" role="menuitem"><i class="codicon codicon-search"></i>Open Quick Chat</div>
            <div class="item" data-action="new-window" role="menuitem"><i class="codicon codicon-window"></i>New Chat Window</div>
          </div>
        </div>
      </div>
      <div class="title-actions">
        <button class="btn icon" title="Toggle Sidebar (Ctrl+B)" id="btnSidebar">
          <i class="codicon codicon-layout-sidebar-left"></i>
          <svg class="icon fallback-icon"><use href="#icon-sidebar"/></svg>
        </button>
        <button class="btn icon" title="Toggle Terminal (Ctrl+`)" id="btnTerminal">
          <i class="codicon codicon-layout-panel"></i>
          <svg class="icon fallback-icon"><use href="#icon-terminal"/></svg>
        </button>
        <button class="btn icon" title="Chat" id="btnChat">
          <i class="codicon codicon-layout-sidebar-right"></i>
          <svg class="icon fallback-icon"><use href="#icon-info"/></svg>
        </button>
        <button class="btn icon updates-btn" title="Updates" id="btnUpdates" aria-haspopup="dialog" aria-expanded="false">
          <img class="vscode-mark" src="./assets/visual-studio-code-icons/vscode.svg" alt="Updates" />
          <span class="updates-dot" aria-hidden="true"></span>
        </button>
      </div>
    </div>

    <div class="main">
      <div class="activitybar">
        <div class="act active" data-view="explorer" title="Explorer">
          <i class="codicon codicon-files codicon-lg"></i>
          <svg class="icon icon-lg fallback-icon"><use href="#icon-files"/></svg>
        </div>
        <div class="act" data-view="search" title="Search">
          <i class="codicon codicon-search codicon-lg"></i>
          <svg class="icon icon-lg fallback-icon"><use href="#icon-search"/></svg>
        </div>
        <div class="act" data-view="scm" title="Source Control">
          <i class="codicon codicon-source-control codicon-lg"></i>
          <svg class="icon icon-lg fallback-icon"><use href="#icon-git"/></svg>
        </div>
        <div class="act" data-view="run" title="Run and Debug">
          <i class="codicon codicon-debug-alt codicon-lg"></i>
          <svg class="icon icon-lg fallback-icon"><use href="#icon-debug"/></svg>
        </div>
        <div class="act" data-view="ext" title="Extensions">
          <i class="codicon codicon-extensions codicon-lg"></i>
          <svg class="icon icon-lg fallback-icon"><use href="#icon-extensions"/></svg>
        </div>
        <div style="flex:1"></div>
        <div class="act" title="Settings">
          <i class="codicon codicon-settings-gear codicon-lg"></i>
          <svg class="icon icon-lg fallback-icon"><use href="#icon-settings"/></svg>
        </div>
      </div>

      <div class="sidebar">
        <div class="sidebar-header">
          <div class="sidebar-title" id="sidebarTitle">EXPLORER</div>
          <button class="btn icon" id="btnSidebarClose">
            <i class="codicon codicon-close"></i>
            <svg class="icon fallback-icon"><use href="#icon-close"/></svg>
          </button>
        </div>
        <div class="sidebar-body">
          <div class="tree" id="tree"></div>
        </div>
      </div>

      <div class="content">
        <div class="tabs" id="tabs"></div>

        <div class="editor-wrap">
          <div class="gutter" id="gutter"></div>
          <div class="editor" id="editor">
            <div class="editor-container">
              <pre class="highlight" id="hl"></pre>
              <textarea id="ta" spellcheck="false"></textarea>
            </div>
          </div>
          <!-- Editor empty state overlays the full editor region (gutter + editor) -->
          <div class="editor-empty" id="editorEmpty" aria-hidden="true">
            <div class="empty-inner">
              <div class="empty-logo" aria-hidden="true">
                <i class="codicon codicon-vscode logo"></i>
              </div>
              <div class="empty-hints" id="emptyHints">
                <div class="hint-row">
                  <span class="hint-label">Show All Commands</span>
                  <span class="hint-keys" data-shortcut="showCommands"></span>
                </div>
                <div class="hint-row">
                  <span class="hint-label">Go to File</span>
                  <span class="hint-keys" data-shortcut="goToFile"></span>
                </div>
                <div class="hint-row">
                  <span class="hint-label">Open Chat</span>
                  <span class="hint-keys" data-shortcut="openChat"></span>
                </div>
                <div class="hint-row">
                  <span class="hint-label">Toggle Terminal</span>
                  <span class="hint-keys" data-shortcut="toggleTerminal"></span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="panel-resizer" id="panelResizer" aria-hidden="true"></div>

        <div class="panel">
          <div class="panel-tabs">
            <div class="panel-left">
              <div class="pill active">Terminal</div>
              <div class="pill">Problems</div>
              <div class="pill">Output</div>
            </div>
            <div class="panel-right">
              <button class="btn icon" id="btnPanelClose">
                <i class="codicon codicon-close"></i>
                <svg class="icon fallback-icon"><use href="#icon-close"/></svg>
              </button>
            </div>
          </div>

          <div class="terminal" id="termOut">
            <div class="term-output" id="termOutput"></div>
            <div class="term-input-line">
              <span class="prompt">$</span>
              <div class="cmd-wrap">
                <input class="cmd" id="termIn" placeholder="Type 'help' for commands" autocomplete="off" />
                <div class="suggest" id="termSuggest"></div>
            </div>
          </div>
          </div>
        </div>
      </div>
      <div class="resizer-x" id="auxResizer"></div>
      <div class="auxiliarybar" id="aux">
        <div class="aux-header">
          <div class="aux-title">CHAT</div>
          <button class="btn icon" id="btnAuxClose">
            <i class="codicon codicon-close"></i>
            <svg class="icon fallback-icon"><use href="#icon-close"/></svg>
          </button>
        </div>
        <div class="aux-body" id="chatLog">
          <div class="chat-empty-state" id="auxEmpty">
            <div class="aux-empty-content">
              <div class="aux-empty-icon">
                <i class="codicon codicon-chat-sparkle"></i>
              </div>
              <div class="aux-empty-copy">
                Ask anything to get started
              </div>
            </div>
          </div>
        </div>
        <div class="aux-input">
          <input id="chatInput" placeholder="Ask something…" />
          <button class="btn" id="chatSend">
            <i class="codicon codicon-send"></i>
            <svg class="icon fallback-icon"><use href="#icon-output"/></svg>
          </button>
        </div>
        <div class="aux-chat-bar">
          <div class="copilot-pill copilot-active" aria-hidden="true"><i class="codicon codicon-copilot"></i></div>
          <button class="btn icon" id="auxAttach"><i class="codicon codicon-attach"></i></button>
          <span class="dropdown-wrap">
            <select id="auxMode" title="Mode">
              <option>Agent</option>
              <option>Plan</option>
              <option>Ask</option>
              <option>Edit</option>
            </select>
            <i class="codicon codicon-chevron-down"></i>
          </span>
          <span class="dropdown-wrap">
            <select id="auxModel" title="Model">
              <option>GPT-5 mini</option>
              <option>GPT-4.1</option>
              <option>Claude Haiku 4.5</option>
            </select>
            <i class="codicon codicon-chevron-down"></i>
          </span>
        </div>
      </div>
    </div>

    <div class="statusbar">
      <div class="status-left">
        <span class="status-item">
          <i class="codicon codicon-info"></i>
          <svg class="icon fallback-icon"><use href="#icon-info"/></svg>
          <span id="statusMsg">Ready</span>
        </span>
      </div>
      <div class="status-right">
        <span class="status-item">
          <i class="codicon codicon-code"></i>
          <svg class="icon fallback-icon"><use href="#icon-file-code"/></svg>
          <span id="statusFile">app.js</span>
        </span>
        <span id="statusPos">Ln 1, Col 1</span>
      </div>
    </div>
  </div>

  <div class="overlay" id="overlay">
    <div class="palette">
      <input id="palInput" autocomplete="off" placeholder="Type a command…" />
      <div class="palette-list" id="palList"></div>
    </div>
  </div>

  <!-- Updates Modal -->
  <div class="updates-overlay" id="updatesOverlay" aria-hidden="true">
    <div class="updates-modal" role="dialog" aria-modal="true" aria-label="Updates">
      <div class="updates-header">
        <div class="updates-title">
          <img class="vscode-mark" src="./assets/visual-studio-code-icons/vscode.svg" alt="" aria-hidden="true" />
          <span>Updates</span>
        </div>
        <button class="btn icon" id="btnUpdatesClose" aria-label="Close Updates">
          <i class="codicon codicon-close"></i>
        </button>
      </div>
      <div class="updates-body" id="updatesBody">
        <div class="term-dim">Loading…</div>
      </div>
    </div>
  </div>

  <!-- Standalone Chat Window -->
  <div class="chat-overlay" id="chatOverlay" aria-hidden="true">
    <div class="chat-window" role="dialog" aria-modal="true" aria-label="Chat Window">
      <div class="chat-header">
        <div>Chat — <span id="chatProjName">js-embeddings-1</span></div>
        <div style="display:flex;gap:6px;align-items:center">
          <button class="btn icon" id="chatWinClose"><i class="codicon codicon-close"></i></button>
        </div>
      </div>
      <div class="chat-body" id="chatWinBody">
        <div class="chat-empty">
          <i class="codicon codicon-chat-sparkle"></i>
          <div>Build with Agent</div>
        </div>
      </div>
      <div class="chat-composer">
        <div class="copilot-pill copilot-active" aria-hidden="true"><i class="codicon codicon-copilot"></i></div>
        <button class="btn icon" id="chatAttach"><i class="codicon codicon-attach"></i></button>
        <span class="dropdown-wrap">
          <select id="chatMode" title="Mode">
          <option>Agent</option>
          <option>Plan</option>
          <option>Ask</option>
          <option>Edit</option>
          </select>
          <i class="codicon codicon-chevron-down"></i>
        </span>
        <span class="dropdown-wrap">
          <select id="chatModel" title="Model">
          <option>GPT-5 mini</option>
          <option>GPT-4.1</option>
          <option>Claude Haiku 4.5</option>
          </select>
          <i class="codicon codicon-chevron-down"></i>
        </span>
        <input id="chatInputStandalone" placeholder="Describe what to build next" />
        <button class="btn" id="chatSendStandalone"><i class="codicon codicon-send"></i></button>
      </div>
    </div>
  </div>
  <!-- Hidden theme file picker -->
  <input type="file" id="themeFile" accept=".json,.jsonc,application/json" style="display:none" />

  <script>
    // [Previous JavaScript code - same as before, keeping it concise]
    const wb = document.getElementById('wb');
    const ta = document.getElementById('ta');
    const hl = document.getElementById('hl');
    const gutter = document.getElementById('gutter');
    const editor = document.getElementById('editor');
    const editorEmpty = document.getElementById('editorEmpty');
    const editorContainer = editor.querySelector('.editor-container');
    const statusMsg = document.getElementById('statusMsg');
    const statusFile = document.getElementById('statusFile');
    const statusPos = document.getElementById('statusPos');
    const titleText = document.getElementById('titleText');
    const tree = document.getElementById('tree');
    const sidebarTitle = document.getElementById('sidebarTitle');
    const tabs = document.getElementById('tabs');
    const contentEl = document.querySelector('.content');
    const overlay = document.getElementById('overlay');
    const palInput = document.getElementById('palInput');
    const palList = document.getElementById('palList');
    const termOut = document.getElementById('termOut');
    const termOutput = document.getElementById('termOutput');
    const termIn = document.getElementById('termIn');
    const termSuggest = document.getElementById('termSuggest');
    const projectQuick = document.getElementById('projectQuick');
    const projectNameEl = document.getElementById('projectName');
    const chatMenu = document.getElementById('chatMenu');
    const btnChatMenu = document.getElementById('btnChatMenu');
    const btnUpdates = document.getElementById('btnUpdates');
    const updatesOverlay = document.getElementById('updatesOverlay');
    const btnUpdatesClose = document.getElementById('btnUpdatesClose');
    const updatesBody = document.getElementById('updatesBody');
    const chatOverlay = document.getElementById('chatOverlay');
    const chatProjName = document.getElementById('chatProjName');
    const chatWinBody = document.getElementById('chatWinBody');
    const chatWinClose = document.getElementById('chatWinClose');
    const chatInputStandalone = document.getElementById('chatInputStandalone');
    const chatSendStandalone = document.getElementById('chatSendStandalone');
    const btnChat = document.getElementById('btnChat');
    const aux = document.getElementById('aux');
    const auxResizer = document.getElementById('auxResizer');
    const panelResizer = document.getElementById('panelResizer');
    const chatLog = document.getElementById('chatLog');
    const auxEmptyState = document.getElementById('auxEmpty');
    const chatInput = document.getElementById('chatInput');
    const themeFile = document.getElementById('themeFile');

    const fileIcons = {
      'js': 'file-code', 'jsx': 'file-code', 'ts': 'file-code',
      'json': 'json', 'md': 'markdown', 'css': 'css',
      'html': 'file-code', 'default': 'file'
    };

    // --- Project seeders (Option 1: bundled example; Option 2: user-chosen folder) ---
    async function loadDefaultProjectFromAssets(manifestPath = 'assets/examples/default/project.json') {
      try {
        const manifestUrl = new URL(manifestPath, location.href);
        const res = await fetch(manifestUrl, { cache: 'no-cache' });
        if (!res.ok) throw new Error('manifest fetch failed');
        const manifest = await res.json();
        const base = manifest.base
          ? new URL(manifest.base, manifestUrl).href
          : manifestUrl.href.replace(/[^/]*$/, '');
        const next = new Map();
        for (const item of (manifest.files || [])) {
          const p = typeof item === 'string' ? item : item.path;
          const fileUrl = new URL(p, base);
          const txt = await fetch(fileUrl, { cache: 'no-cache' }).then(r => r.text());
          const name = p.split('/').pop();
          next.set(name, txt);
        }
        if (next.size > 0) {
          files = next;
          if (projectNameEl && manifest.name) {
            projectNameEl.textContent = manifest.name;
            if (chatProjName) chatProjName.textContent = manifest.name;
          }
          saveToStorage();
        }
        return true;
      } catch (e) {
        console.warn('Default asset load failed:', e);
        return false;
      }
    }

    async function loadProjectFromDirectoryPicker() {
      try {
        const dirHandle = await window.showDirectoryPicker();
        const next = new Map();
        async function walk(handle, prefix='') {
          for await (const [name, entry] of handle.entries()) {
            const rel = prefix ? `${prefix}/${name}` : name;
            if (entry.kind === 'file') {
              const file = await entry.getFile();
              const txt = await file.text().catch(()=> '');
              next.set(rel, txt);
            } else if (entry.kind === 'directory') {
              await walk(entry, rel);
            }
          }
        }
        await walk(dirHandle);
        if (next.size > 0) {
          files = next;
          projectNameEl && (projectNameEl.textContent = dirHandle.name || 'Project');
          chatProjName && (chatProjName.textContent = dirHandle.name || 'Project');
          saveToStorage();
          currentFile = 'README.md';
          if (!files.has(currentFile)) {
            const first = [...files.keys()][0];
            if (first) currentFile = first;
          }
          renderTree(); renderTabs(); openFile(currentFile); setDirty(false);
          setStatus(`Opened folder ${projectNameEl?.textContent || ''}`);
        } else {
          setStatus('No files found in folder');
        }
      } catch (e) {
        console.warn('Folder open cancelled or failed', e);
      }
    }

    // Prefer Codicons if font is available; otherwise use embedded SVG fallbacks
    (function ensureCodiconDetection(){
      try {
        if (!('fonts' in document)) return;
        document.fonts.load('16px codicon').then(list => {
          if (list && list.length) {
            document.body.classList.remove('no-codicon');
            document.body.classList.add('has-codicon');
            // Font swap can shift layout; refresh editor highlight
            refreshEditorSoon?.();
          }
        });
      } catch {}
    })();

    function iconHTML(name, extraClass='') {
      // Renders a codicon + SVG fallback pair
      const cod = `<i class="codicon codicon-${name}${extraClass ? ' '+extraClass : ''}"></i>`;
      const svg = `<svg class="icon fallback-icon${extraClass ? ' '+extraClass : ''}"><use href="#icon-${name}"/></svg>`;
      return cod + svg;
    }

    // --- Seti file icons (for tabs + explorer) ---
    let setiTheme = null;
    let setiIconDefs = {};
    let setiFileExt = {};
    let setiFileNames = {};
    let setiLanguageIds = {}; // Fallback for common file types
    let setiDefaultId = '_default';
    
    // Map common extensions to languageIds (VS Code pattern)
    const extToLanguageId = {
      'js': 'javascript',
      'jsx': 'javascriptreact',
      'ts': 'typescript',
      'tsx': 'typescriptreact',
      'css': 'css',
      'scss': 'scss',
      'sass': 'sass',
      'less': 'less',
      'md': 'markdown',
      'mdx': 'markdown',
      'html': 'html',
      'htm': 'html',
      'json': 'json',
      'jsonc': 'jsonc',
      'py': 'python',
      'sh': 'shellscript',
      'bash': 'shellscript',
      'zsh': 'shellscript',
      'xml': 'xml',
    };

    function decodeSetiFontCharacter(fontCharacter) {
      // Theme uses strings like "\\E051" (private use area). Convert to actual char.
      if (!fontCharacter) return '';
      const str = String(fontCharacter);
      // Handle escaped Unicode: "\\E051" -> \uE051
      // Match \E followed by 3-4 hex digits, capture the E and digits together
      const m = str.match(/\\E([0-9a-fA-F]{3,4})/);
      if (m) {
        // Parse "E" + hex digits as hex (e.g., "E051" = 0xE051)
        const code = parseInt('E' + m[1], 16);
        return String.fromCharCode(code);
      }
      // Fallback: if it's already a single char, return it
      if (str.length === 1) return str;
      return '';
    }

    function getSetiSpec(filename) {
      if (!setiTheme) {
        console.warn('Seti theme not loaded for', filename);
        return null;
      }
      const base = String(filename || '').split('/').pop();
      const lower = base.toLowerCase();

      // 1. Check fileNames first (exact match)
      const idFromName = setiFileNames[base] || setiFileNames[lower];
      if (idFromName) {
        const def = setiIconDefs[idFromName];
        if (def) {
          const ch = decodeSetiFontCharacter(def.fontCharacter);
          if (ch) return { ch, color: def.fontColor || '' };
        }
      }

      // 2. Check fileExtensions
      const ext = (base.includes('.') ? base.split('.').pop() : '').toLowerCase();
      let idFromExt = ext ? setiFileExt[ext] : null;
      
      // 3. If not found in fileExtensions, try languageIds as fallback
      if (!idFromExt && ext && extToLanguageId[ext]) {
        const langId = extToLanguageId[ext];
        idFromExt = setiLanguageIds[langId] || null;
      }
      
      const id = idFromName || idFromExt || setiDefaultId || '_default';

      const def = setiIconDefs[id] || setiIconDefs['_default'];
      if (!def) {
        console.warn('No icon definition for', filename, 'id:', id);
        return null;
      }
      const ch = decodeSetiFontCharacter(def.fontCharacter);
      if (!ch) {
        console.warn('Failed to decode character for', filename, 'fontCharacter:', def.fontCharacter);
        return null;
      }
      return {
        ch: ch,
        color: def.fontColor || '',
      };
    }

    function fileIconHTML(filename) {
      const spec = getSetiSpec(filename);
      if (spec?.ch) {
        // Apply color directly as inline style - this should override inherited colors
        const c = spec.color ? ` style="color: ${spec.color};"` : '';
        // Don't escape Unicode characters - they need to render as-is
        // Use data attribute for debugging
        return `<span class="file-icon seti" aria-hidden="true" data-file="${escapeHtml(filename)}"${c}>${spec.ch}</span>`;
      }
      // Fallback to old behavior (codicons)
      const icon = getIcon(filename);
      return iconHTML(icon);
    }

    async function loadSetiThemeFromAssets(url = 'assets/seti-theme-icons/vs-seti-icon-theme.json') {
      try {
        const res = await fetch(new URL(url, location.href), { cache: 'no-cache' });
        if (!res.ok) throw new Error(`seti theme fetch failed: ${res.status} ${res.statusText}`);
        const obj = await res.json();
        setiTheme = obj;
        setiIconDefs = obj.iconDefinitions || {};
        setiFileExt = obj.fileExtensions || {};
        setiFileNames = obj.fileNames || {};
        setiLanguageIds = obj.languageIds || {}; // Load languageIds for fallback
        setiDefaultId = obj.file || '_default';
        console.log('Seti theme loaded:', {
          iconDefs: Object.keys(setiIconDefs).length,
          fileExt: Object.keys(setiFileExt).length,
          fileNames: Object.keys(setiFileNames).length
        });
        return true;
      } catch (e) {
        console.error('Seti theme load failed:', e);
        return false;
      }
    }
    function setEditorEmptyMode(on) {
      if (!editorContainer || !editorEmpty) return;
      
      editorContainer.style.display = on ? 'none' : 'block';
      editorEmpty.classList.toggle('show', !!on);
      editorEmpty.setAttribute('aria-hidden', on ? 'false' : 'true');
      if (on) { statusFile.textContent = '—'; }
      if (contentEl) contentEl.classList.toggle('no-file', !!on);
    }

    function isMacPlatform() {
      // navigator.platform is deprecated but still widely supported; keep it simple for this demo.
      const p = (navigator.platform || '').toLowerCase();
      const ua = (navigator.userAgent || '').toLowerCase();
      return p.includes('mac') || ua.includes('mac os');
    }

    function renderKeycaps(el, keys) {
      if (!el) return;
      el.innerHTML = keys.map(k => `<kbd>${escapeHtml(String(k))}</kbd>`).join('');
    }

    function syncEmptyStateShortcuts() {
      const isMac = isMacPlatform();
      const defs = isMac
        ? {
            showCommands: ['⌘', '⇧', 'P'],
            goToFile: ['⌘', 'P'],
            openChat: ['⌘', '⇧', 'I'],
            toggleTerminal: ['⌃', '`'],
          }
        : {
            showCommands: ['Ctrl', 'Shift', 'P'],
            goToFile: ['Ctrl', 'P'],
            openChat: ['Ctrl', 'Shift', 'I'],
            toggleTerminal: ['Ctrl', '`'],
          };
      document.querySelectorAll('[data-shortcut]').forEach((node) => {
        const key = node.getAttribute('data-shortcut');
        renderKeycaps(node, defs[key] || []);
      });
    }
    // Project quick palette and chat menu
    const PROJECT_NAME = projectNameEl?.textContent || 'js-embeddings-1';
    chatProjName && (chatProjName.textContent = PROJECT_NAME);
    projectQuick?.addEventListener('click', ()=>showPalette('commands'));
    projectQuick?.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' ') { e.preventDefault(); showPalette('commands'); }});
    btnChatMenu?.addEventListener('click', (e)=>{ e.stopPropagation(); chatMenu.classList.toggle('show'); });
    chatMenu?.addEventListener('click', (e)=>{
      const item = e.target.closest('.item'); if(!item) return;
      const act = item.dataset.action;
      if (act === 'new-window') { chatOverlay.classList.add('show'); }
      chatMenu.classList.remove('show');
    });
    window.addEventListener('click', (e)=>{ if(!e.target.closest?.('#chatMenu') && !e.target.closest?.('#btnChatMenu')) chatMenu.classList.remove('show'); });
    chatWinClose?.addEventListener('click', ()=> chatOverlay.classList.remove('show'));
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') { chatOverlay.classList.remove('show'); chatMenu?.classList.remove('show'); }});

    // Updates modal
    function renderMarkdown(md) {
      // Minimal Markdown renderer: headings, paragraphs, lists, links, images, code fences.
      const lines = String(md || '').replace(/\r\n/g, '\n').split('\n');
      let out = '';
      let inCode = false;
      let codeLang = '';
      let listOpen = false;
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        const trimmed = line.trim();

        const fence = trimmed.match(/^```(\w+)?$/);
        if (fence) {
          if (!inCode) {
            inCode = true; codeLang = fence[1] || '';
            out += `<pre><code data-lang="${escapeHtml(codeLang)}">`;
          } else {
            inCode = false;
            out += `</code></pre>`;
          }
          continue;
        }
        if (inCode) {
          out += escapeHtml(line) + '\n';
          continue;
        }

        if (!trimmed) {
          if (listOpen) { out += '</ul>'; listOpen = false; }
          continue;
        }

        const h = trimmed.match(/^(#{1,3})\s+(.*)$/);
        if (h) {
          if (listOpen) { out += '</ul>'; listOpen = false; }
          const lvl = h[1].length;
          out += `<h${lvl}>${escapeHtml(h[2])}</h${lvl}>`;
          continue;
        }

        const li = trimmed.match(/^[-*]\s+(.*)$/);
        if (li) {
          if (!listOpen) { out += '<ul>'; listOpen = true; }
          out += `<li>${escapeHtml(li[1])}</li>`;
          continue;
        }

        // images ![alt](src)
        const img = trimmed.match(/^!\[(.*?)\]\((.*?)\)$/);
        if (img) {
          if (listOpen) { out += '</ul>'; listOpen = false; }
          out += `<img src="${escapeHtml(img[2])}" alt="${escapeHtml(img[1])}" loading="lazy" />`;
          continue;
        }

        // inline links [text](href)
        const para = escapeHtml(trimmed).replace(/\[([^\]]+)\]\(([^)]+)\)/g, (m, t, href) => {
          return `<a href="${escapeHtml(href)}" target="_blank" rel="noreferrer">${escapeHtml(t)}</a>`;
        });
        if (listOpen) { out += '</ul>'; listOpen = false; }
        out += `<p>${para}</p>`;
      }
      if (listOpen) out += '</ul>';
      if (inCode) out += '</code></pre>';
      return out;
    }
    async function openUpdates() {
      if (!updatesOverlay || !updatesBody) return;
      updatesOverlay.classList.add('show');
      updatesOverlay.setAttribute('aria-hidden', 'false');
      btnUpdates?.setAttribute('aria-expanded', 'true');
      try {
        const res = await fetch('./assets/updates/update.md', { cache: 'no-cache' });
        const text = res.ok ? await res.text() : `# Updates\n\nCould not load \`assets/updates/update.md\`.\n`;
        updatesBody.innerHTML = renderMarkdown(text);
      } catch (e) {
        updatesBody.innerHTML = `<p>Failed to load updates.</p>`;
      }
    }
    function closeUpdates() {
      updatesOverlay?.classList.remove('show');
      updatesOverlay?.setAttribute('aria-hidden', 'true');
      btnUpdates?.setAttribute('aria-expanded', 'false');
    }
    btnUpdates?.addEventListener('click', (e)=>{ e.preventDefault(); openUpdates(); });
    btnUpdatesClose?.addEventListener('click', (e)=>{ e.preventDefault(); closeUpdates(); });
    updatesOverlay?.addEventListener('mousedown', (e)=>{ if (e.target === updatesOverlay) closeUpdates(); });
    window.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') closeUpdates(); });
    function chatWinPost(role, text) {
      const div = document.createElement('div');
      div.className = `chat-bubble ${role}`;
      div.textContent = text;
      chatWinBody.appendChild(div);
      chatWinBody.scrollTop = chatWinBody.scrollHeight;
    }
    chatSendStandalone?.addEventListener('click', ()=>{
      const q = chatInputStandalone.value.trim(); if(!q) return;
      chatWinPost('user', q);
      chatInputStandalone.value='';
      setTimeout(()=>chatWinPost('bot', 'Echo: '+q), 200);
    });
    chatInputStandalone?.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); chatSendStandalone.click(); }});

    function getIcon(filename) {
      const ext = filename.split('.').pop().toLowerCase();
      return fileIcons[ext] || fileIcons.default;
    }

    const defaultFiles = {
      'app.js': `// app.js
function greet(name) {
  return \`Hello, \${name}!\`;
}

const who = "world";
console.log(greet(who));`,
      'README.md': `# VS Code-ish

## Official VS Code Logo
Now using the authentic VS Code logo icon!

## Sustainability Path
**Current:** Embedded SVG icons (25 icons)
**Recommended:** Official Codicons (400+ icons)

### How to Upgrade to Codicons:
1. Download from: https://github.com/microsoft/vscode-codicons
2. Self-host \`codicon.css\` and \`codicon.ttf\`
3. Replace SVG usage with: \`<i class="codicon codicon-name"></i>\`

## Features
✅ Official VS Code logo
✅ Syntax highlighting  
✅ Current line highlighting
✅ localStorage persistence
✅ Terminal with history
✅ Keyboard shortcuts

## Shortcuts
**Ctrl+Shift+P** - Command Palette
**Ctrl+P** - Quick Open
**Ctrl+B** - Toggle Sidebar  
**Ctrl+\`** - Toggle Terminal
**Ctrl+S** - Save`,
      'style.css': `:root {
  --primary: #007acc;
  --bg: #1e1e1e;
  --fg: #d4d4d4;
}

body {
  font-family: system-ui;
  background: var(--bg);
  color: var(--fg);
  margin: 0;
  padding: 0;
}`
    };

    let files = new Map();
    let savedRaw = null;
    try {
      savedRaw = localStorage.getItem('vscode-ish-files');
      files = savedRaw ? new Map(Object.entries(JSON.parse(savedRaw))) : new Map(Object.entries(defaultFiles));
    } catch {
      files = new Map(Object.entries(defaultFiles));
    }
    if (files.size === 0) {
      files = new Map(Object.entries(defaultFiles));
      try { localStorage.setItem('vscode-ish-files', JSON.stringify(Object.fromEntries(files))); } catch {}
    }

    // Pick a sensible initial file to ensure code is visible on first load
    let currentFile = 'app.js', dirty = false, currentLine = 1;
    (function chooseInitialFile(){
      try {
        const get = (n)=> (files.get(n)||'').trim();
        const candidates = ['app.js','README.md','readme.md','index.js','style.css'];
        for (const name of candidates) {
          if (files.has(name) && get(name).length>0) { currentFile = name; return; }
        }
        for (const [name,content] of files) {
          if ((content||'').trim().length>0) { currentFile = name; return; }
        }
        // If all files are empty, ensure we at least have one tab
        const first = [...files.keys()][0];
        if (first) currentFile = first;
      } catch {}
    })();
    // Ensure the chosen current file exists in the map so tabs and explorer render
    if (!files.has(currentFile)) {
      files.set(currentFile, defaultFiles[currentFile] ?? '');
      try { localStorage.setItem('vscode-ish-files', JSON.stringify(Object.fromEntries(files))); } catch {}
    }
    let termHistory = [], termHistoryIndex = -1;

    function saveToStorage() {
      try { localStorage.setItem('vscode-ish-files', JSON.stringify(Object.fromEntries(files))); } 
      catch (e) { console.error(e); }
    }

    function setStatus(msg) {
      statusMsg.textContent = msg;
      clearTimeout(setStatus._t);
      setStatus._t = setTimeout(() => statusMsg.textContent = dirty ? 'Unsaved' : 'Ready', 1200);
    }

    function setDirty(isDirty) {
      dirty = isDirty;
      updateTabState();
      titleText.textContent = isDirty ? `● ${currentFile}` : currentFile;
    }

    // [Rest of JavaScript - tokenizer, highlighting, etc. - keeping previous implementation]
    function tokenize(code) {
      const tokens = [], KEYWORDS = ['const','let','var','function','return','if','else','for','while','break','continue','class','new','try','catch','throw','import','from','export','default','async','await'], TYPES = ['String','Number','Boolean','Object','Array','Map','Set','Promise'];
      let i = 0;
      while (i < code.length) {
        const char = code[i];
        if (code.substr(i,2)==='/*') { const end=code.indexOf('*/',i+2),len=end===-1?code.length-i:end-i+2; tokens.push({type:'comment',value:code.substr(i,len)}); i+=len; continue; }
        if (code.substr(i,2)==='//') { const end=code.indexOf('\n',i),len=end===-1?code.length-i:end-i; tokens.push({type:'comment',value:code.substr(i,len)}); i+=len; continue; }
        if (char==='"'||char==="'"||char==='`') { let j=i+1,escaped=false; while(j<code.length) { if(escaped) {escaped=false;j++;continue;} if(code[j]==='\\') {escaped=true;j++;continue;} if(code[j]===char) {j++;break;} j++; } tokens.push({type:'string',value:code.substring(i,j)}); i=j; continue; }
        if (/\d/.test(char)) { let j=i; while(j<code.length&&/[\d.]/.test(code[j]))j++; tokens.push({type:'number',value:code.substring(i,j)}); i=j; continue; }
        if (/[a-zA-Z_$]/.test(char)) { let j=i; while(j<code.length&&/[a-zA-Z0-9_$]/.test(code[j]))j++; const word=code.substring(i,j); let k=j; while(k<code.length&&/\s/.test(code[k]))k++; const isFunc=code[k]==='('; let type='plain'; if(KEYWORDS.includes(word))type='keyword'; else if(TYPES.includes(word))type='type'; else if(isFunc)type='function'; tokens.push({type,value:word}); i=j; continue; }
        tokens.push({type:'plain',value:char}); i++;
      }
      return tokens;
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, (c) => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;',
      }[c]));
    }

    function highlight(code,ln) {
      const tokens=tokenize(code);
      const lines=[];
      let lineTokens=[];
      let lineNum=1;
      
      for(const token of tokens) {
        const parts=token.value.split('\n');
        for(let i=0;i<parts.length;i++) {
          if(i>0) {
            // End of line - push accumulated tokens
            const html=lineTokens.join('');
            const isCur=lineNum===ln;
            lines.push(`<span class="line${isCur?' current-line':''}">${html||' '}</span>`);
            lineTokens=[];
            lineNum++;
          }
          if(parts[i]) {
            const cls=token.type==='keyword'?'tok-k':
                      token.type==='string'?'tok-s':
                      token.type==='number'?'tok-n':
                      token.type==='comment'?'tok-c':
                      token.type==='function'?'tok-f':
                      token.type==='type'?'tok-t':'';
            // Only wrap if it needs styling
            if(cls) {
              lineTokens.push(`<span class="${cls}">${escapeHtml(parts[i])}</span>`);
            } else {
              lineTokens.push(escapeHtml(parts[i]));
            }
          }
        }
      }
      
      // Don't forget the last line
      if(lineTokens.length>0||lines.length===0) {
        const html=lineTokens.join('');
        const isCur=lineNum===ln;
        lines.push(`<span class="line${isCur?' current-line':''}">${html||' '}</span>`);
      }
      
      return lines.join('');
    }

    function syncGutter() { const lines=ta.value.split('\n').length; gutter.innerHTML=''; for(let i=1;i<=lines;i++) { const d=document.createElement('div'); d.textContent=i; if(i===currentLine)d.className='current-line'; gutter.appendChild(d); }}
    function syncScroll() { gutter.scrollTop=editor.scrollTop; }
    function updateCursorStatus() { const idx=ta.selectionStart,before=ta.value.slice(0,idx),ln=before.split('\n').length,col=before.length-before.lastIndexOf('\n'); statusPos.textContent=`Ln ${ln}, Col ${col}`; if(currentLine!==ln) {currentLine=ln;syncHighlightAndGutter();}}
    function syncHighlightAndGutter() { syncGutter(); hl.innerHTML=highlight(ta.value,currentLine); updateCursorStatus(); }

    // Ensure highlight refresh after layout changes
    let raf1=0, raf2=0;
    function refreshEditorSoon() {
      cancelAnimationFrame(raf1); cancelAnimationFrame(raf2);
      raf1 = requestAnimationFrame(()=>{ raf2 = requestAnimationFrame(()=>{ syncHighlightAndGutter(); }); });
    }

    let inputTimeout;
    ta.addEventListener('input',()=>{clearTimeout(inputTimeout);inputTimeout=setTimeout(()=>{syncHighlightAndGutter();setDirty(true);},50);});
    editor.addEventListener('scroll',syncScroll);
    ta.addEventListener('click',updateCursorStatus);
    ta.addEventListener('keyup',updateCursorStatus);
    ta.addEventListener('keydown',(e)=>{
      if(e.key==='Tab') {e.preventDefault();const start=ta.selectionStart,end=ta.selectionEnd;ta.value=ta.value.slice(0,start)+'  '+ta.value.slice(end);ta.selectionStart=ta.selectionEnd=start+2;syncHighlightAndGutter();setDirty(true);}
      if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='s') {e.preventDefault();files.set(currentFile,ta.value);setDirty(false);saveToStorage();setStatus('Saved');}
    });

    function renderTabs() {
      tabs.innerHTML='';
      [...files.keys()].forEach(file=>{
        const tab=document.createElement('div');
        tab.className='tab'+(file===currentFile?' active':'');
        tab.dataset.file=file;
        const isDirty=file===currentFile&&dirty;
        const fileIcon=isDirty ? '<span class="dot-unsaved"></span>' : fileIconHTML(file);
        tab.innerHTML=`${fileIcon}<span class="name">${file}</span>${iconHTML('close','close')}`;
        tabs.appendChild(tab);
      });
    }
    function updateTabState() { 
      renderTabs(); 
      setEditorEmptyMode(!currentFile); 
    }

    tabs.addEventListener('click',(e)=>{const tab=e.target.closest('.tab');if(!tab)return;if(e.target.closest('.close')) {e.stopPropagation();const file=tab.dataset.file;if(file===currentFile&&dirty&&!confirm(`Close ${file}?`))return;files.delete(file);saveToStorage();if(file===currentFile) {const remaining=[...files.keys()];if(remaining.length>0)openFile(remaining[0]);else{currentFile=null;setEditorEmptyMode(true);renderTabs();renderTree();setStatus('No file open');}}else{renderTabs();renderTree();}return;}openFile(tab.dataset.file);});

    function renderTree(view='explorer') {
      tree.innerHTML='';
      sidebarTitle.textContent=view.toUpperCase();
      if(view==='explorer') {
        [...files.keys()].forEach(file=>{
          const row=document.createElement('div');
          row.className='item'+(file===currentFile?' active':'');
          row.innerHTML=`${fileIconHTML(file)}<span>${file}</span>`;
          row.onclick=()=>openFile(file);
          tree.appendChild(row);
        });
      } else {
        tree.innerHTML=`<div class="term-dim" style="padding:6px">(${view}) Placeholder</div>`;
      }
    }

    function openFile(file) { if(!file || !files.has(file)) { currentFile=null; setEditorEmptyMode(true); renderTabs(); renderTree(); return; } if(dirty){files.set(currentFile,ta.value);saveToStorage();setDirty(false);} currentFile=file; statusFile.textContent=file; setEditorEmptyMode(false); ta.value=files.get(file)??''; currentLine=1; syncHighlightAndGutter(); renderTabs(); renderTree(); setStatus(`Opened ${file}`); ta.focus(); }

    document.querySelectorAll('.act[data-view]').forEach(btn=>btn.addEventListener('click',()=>{document.querySelectorAll('.act[data-view]').forEach(b=>b.classList.remove('active'));btn.classList.add('active');renderTree(btn.dataset.view);}));
    document.querySelectorAll('.pill').forEach(p=>p.addEventListener('click',()=>{document.querySelectorAll('.pill').forEach(x=>x.classList.remove('active'));p.classList.add('active');}));
    function setToggleIcon(button, onClass, offClass, isOn) {
      const i = button.querySelector('.codicon');
      if (!i) return;
      i.className = `codicon ${isOn ? onClass : offClass}`;
    }
    function syncToggleButtons() {
      const isSidebarVisible = !wb.classList.contains('hide-sidebar');
      const isPanelVisible = !wb.classList.contains('hide-panel');
      const isAuxVisible = !wb.classList.contains('hide-auxiliary');
      const bSidebar = document.getElementById('btnSidebar');
      const bTerminal = document.getElementById('btnTerminal');
      const bChat = document.getElementById('btnChat');
      // Update icons to reflect state (on/off)
      setToggleIcon(bSidebar, 'codicon-layout-sidebar-right', 'codicon-layout-sidebar-right-off', isSidebarVisible);
      setToggleIcon(bTerminal, 'codicon-layout-panel', 'codicon-layout-panel-off', isPanelVisible);
      setToggleIcon(bChat, 'codicon-layout-sidebar-right', 'codicon-layout-sidebar-right-off', isAuxVisible);
      bSidebar.setAttribute('aria-pressed', String(isSidebarVisible));
      bTerminal.setAttribute('aria-pressed', String(isPanelVisible));
      bChat.setAttribute('aria-pressed', String(isAuxVisible));
    }
    document.getElementById('btnSidebar').onclick=()=>{wb.classList.toggle('hide-sidebar');syncToggleButtons();refreshEditorSoon();};
    document.getElementById('btnTerminal').onclick=()=>{wb.classList.toggle('hide-panel');syncToggleButtons();refreshEditorSoon();};
    document.getElementById('btnSidebarClose').onclick=()=>{
      wb.classList.add('hide-sidebar');
      syncToggleButtons();
      refreshEditorSoon();
    };
    document.getElementById('btnPanelClose').onclick=()=>{
      wb.classList.add('hide-panel');
      syncToggleButtons();
      refreshEditorSoon();
    };
    btnChat.onclick=()=>{wb.classList.toggle('hide-auxiliary');syncToggleButtons();refreshEditorSoon();};
    document.getElementById('btnAuxClose').onclick=()=>{
      wb.classList.add('hide-auxiliary');
      syncToggleButtons();
      refreshEditorSoon();
    };

    const commands=[
      {label:'View: Toggle Sidebar',icon:'sidebar',run:()=>wb.classList.toggle('hide-sidebar'),kbd:'Ctrl+B'},
      {label:'View: Toggle Panel',icon:'terminal',run:()=>wb.classList.toggle('hide-panel'),kbd:'Ctrl+`'},
      {label:'File: Save',icon:'file',run:()=>{files.set(currentFile,ta.value);setDirty(false);saveToStorage();setStatus('Saved');},kbd:'Ctrl+S'},
      {label:'File: New File',icon:'file',run:()=>{const name=prompt('File name:','untitled.txt');if(name&&!files.has(name)){files.set(name,'');saveToStorage();openFile(name);}}},
      {label:'Terminal: Clear',icon:'terminal',run:()=>{termOut.innerHTML='';termPrint('Cleared','term-dim');}},
      {label:'Storage: Reset',icon:'close',run:()=>{if(confirm('Clear all?')){localStorage.removeItem('vscode-ish-files');location.reload();}}},
      {label:'Theme: Apply Dark+',icon:'info',run:()=>{applyWorkbenchTheme({'titleBar.activeBackground':'#1f1f1f','activityBar.background':'#252526','sideBar.background':'#252526','editor.background':'#1e1e1e','panel.background':'#1b1b1b','statusBar.background':'#007acc','tab.activeBackground':'#1e1e1e','tab.activeBorderTop':'#007acc'});setStatus('Theme applied');}},
      {label:'Theme: Import from JSON…',icon:'file',run:()=>{themeFile.value='';themeFile.click();}},
      {label:'Project: Load Example (assets/default)',icon:'files',run:async()=>{await loadDefaultProjectFromAssets(); currentFile='README.md'; if(!files.has(currentFile)){const f=[...files.keys()][0]; if(f) currentFile=f;} renderTree(); renderTabs(); openFile(currentFile); setDirty(false); setStatus('Loaded example project');}},
      {label:'Project: Open Folder…',icon:'files',run:()=>loadProjectFromDirectoryPicker(),kbd:'Ctrl+O'}
    ];

    function showPalette(mode='commands') {overlay.classList.add('show');palInput.value='';palInput.dataset.mode=mode;palInput.placeholder=mode==='files'?'Type file name…':'Type command…';renderPaletteList('');palInput.focus();}
    function hidePalette() {overlay.classList.remove('show');ta.focus();}
    function renderPaletteList(query) {const mode=palInput.dataset.mode||'commands',q=query.trim().toLowerCase();let items=mode==='files'?[...files.keys()].filter(f=>f.toLowerCase().includes(q)).map(f=>({label:f,icon:getIcon(f),run:()=>openFile(f)})):commands.filter(c=>c.label.toLowerCase().includes(q)).slice(0,12);palList.innerHTML='';if(items.length===0) {palList.innerHTML='<div class="pal-item"><div></div><div>No results</div><div></div></div>';return;}items.forEach((it,idx)=>{const row=document.createElement('div');row.className='pal-item'+(idx===0?' active':'');row.innerHTML=`${iconHTML(it.icon||'file')}<div>${it.label}</div><div class="pal-kbd">${it.kbd||'↵'}</div>`;row.onclick=()=>{it.run?.();hidePalette();};palList.appendChild(row);});palList.dataset.count=String(items.length);palList.dataset.selected='0';palList._items=items;}
    function paletteMove(delta) {const count=Number(palList.dataset.count||'0');if(!count)return;let sel=Math.max(0,Math.min(count-1,Number(palList.dataset.selected||'0')+delta));palList.dataset.selected=String(sel);[...palList.children].forEach((el,i)=>el.classList.toggle('active',i===sel));palList.children[sel]?.scrollIntoView({block:'nearest'});}
    function paletteRunSelected() {const items=palList._items||[];items[Number(palList.dataset.selected||'0')]?.run?.();hidePalette();}

    const btnPalette = document.getElementById('btnPalette');
    if (btnPalette) btnPalette.onclick=()=>showPalette('commands');
    overlay.addEventListener('mousedown',(e)=>{if(e.target===overlay)hidePalette();});
    // Also allow clicking anywhere outside the palette to close it
    window.addEventListener('mousedown',(e)=>{ if(overlay.classList.contains('show') && !e.target.closest?.('.palette')) { hidePalette(); }});
    palInput.addEventListener('input',()=>renderPaletteList(palInput.value));
    palInput.addEventListener('keydown',(e)=>{if(e.key==='Escape'){e.preventDefault();hidePalette();}if(e.key==='ArrowDown'){e.preventDefault();paletteMove(+1);}if(e.key==='ArrowUp'){e.preventDefault();paletteMove(-1);}if(e.key==='Enter'){e.preventDefault();paletteRunSelected();}});

    function termPrint(text,cls='term-line') {const div=document.createElement('div');div.className=`term-line ${cls}`.trim();div.textContent=text;if(termOutput)termOutput.appendChild(div);if(termOut)termOut.scrollTop=termOut.scrollHeight;}
    function runTerminalCommand(raw) {const line=raw.trim();if(!line)return;if(termHistory[termHistory.length-1]!==line)termHistory.push(line);termHistoryIndex=termHistory.length;termPrint(`$ ${line}`,'term-dim');const [cmd,...args]=line.split(' ');switch(cmd) {case 'help':termPrint('help, clear, echo, ls, cat, open, new, save','term-ok');termPrint('Use ↑/↓ for history','term-dim');break;case 'clear':termOut.innerHTML='';break;case 'echo':termPrint(args.join(' '));break;case 'ls':[...files.keys()].forEach(f=>termPrint(f));break;case 'cat':const f=args[0];if(!f||!files.has(f))termPrint(`No file: ${f||''}`,'term-err');else termPrint(files.get(f),'term-dim');break;case 'open':const of=args[0];if(!of||!files.has(of))termPrint(`No file: ${of||''}`,'term-err');else{openFile(of);termPrint(`Opened ${of}`,'term-ok');}break;case 'new':const nf=args[0];if(!nf)termPrint('Usage: new <filename>','term-err');else if(files.has(nf))termPrint(`Exists: ${nf}`,'term-err');else{files.set(nf,'');saveToStorage();openFile(nf);termPrint(`Created ${nf}`,'term-ok');}break;case 'save':files.set(currentFile,ta.value);setDirty(false);saveToStorage();termPrint('Saved','term-ok');break;default:termPrint(`Unknown: ${cmd}`,'term-err');}}

    // Terminal suggestions (mock IntelliSense)
    const BASE_SUGGEST = [
      {label:'nano', desc:"Nano's ANOther editor, an enhanced free Pico"},
      {label:'node', desc:'Run the node interpreter'},
      {label:'npm', desc:'Node package manager'},
      {label:'npx', desc:'Execute binaries from npm packages'},
      {label:'nohup', desc:'Run a command immune to hangups'},
      {label:'open', desc:'Open file in editor'},
      {label:'ls', desc:'List files'},
      {label:'cat', desc:'Print file contents'},
      {label:'clear', desc:'Clear terminal'}
    ];
    function buildFileSuggest() {
      return [...files.keys()].map(f=>({label:f, desc:'file'}));
    }
    function renderTermSuggest(prefix) {
      const p = (prefix||'').trim();
      if(!p) { termSuggest.classList.remove('show'); termSuggest.innerHTML=''; return; }
      const pool = [...BASE_SUGGEST, ...buildFileSuggest()];
      const items = pool.filter(it=>it.label.toLowerCase().startsWith(p.toLowerCase())).slice(0,8);
      if(items.length===0){ termSuggest.classList.remove('show'); termSuggest.innerHTML=''; return; }
      termSuggest.innerHTML = items.map((it,i)=>(
        `<div class="sug-row${i===0?' active':''}" data-idx="${i}">
          <div class="sug-icon"><i class="codicon codicon-symbol-variable"></i></div>
          <div class="sug-label">${it.label}</div>
          <div class="sug-desc">${it.desc||''}</div>
        </div>`
      )).join('');
      termSuggest.dataset.count = String(items.length);
      termSuggest.dataset.selected = '0';
      termSuggest._items = items;
      termSuggest.classList.add('show');
    }
    function moveTermSuggest(delta) {
      const count = Number(termSuggest.dataset.count||'0'); if(!count) return;
      let sel = Math.max(0, Math.min(count-1, Number(termSuggest.dataset.selected||'0')+delta));
      termSuggest.dataset.selected = String(sel);
      [...termSuggest.children].forEach((el,i)=>el.classList.toggle('active', i===sel));
    }
    function acceptTermSuggest() {
      const items = termSuggest._items||[]; const sel = Number(termSuggest.dataset.selected||'0');
      const it = items[sel]; if(!it) return false;
      termIn.value = it.label + (it.label.includes(' ')?'':' ');
      termSuggest.classList.remove('show');
      return true;
    }
    termIn.addEventListener('input', ()=>renderTermSuggest(termIn.value.split(/\s+/).pop()));
    termIn.addEventListener('keydown',(e)=>{
      if(termSuggest.classList.contains('show')) {
        if(e.key==='ArrowDown'){ e.preventDefault(); moveTermSuggest(+1); }
        else if(e.key==='ArrowUp'){ e.preventDefault(); moveTermSuggest(-1); }
        else if(e.key==='Tab'){ e.preventDefault(); acceptTermSuggest(); }
        else if(e.key==='Escape'){ termSuggest.classList.remove('show'); }
      }
    });
    termIn.addEventListener('blur', ()=>{ setTimeout(()=>termSuggest.classList.remove('show'), 120); });

    termIn.addEventListener('keydown',(e)=>{if(e.key==='Enter') {e.preventDefault();runTerminalCommand(termIn.value);termIn.value='';}else if(e.key==='ArrowUp') {e.preventDefault();if(termHistoryIndex>0)termIn.value=termHistory[--termHistoryIndex]||'';}else if(e.key==='ArrowDown') {e.preventDefault();if(termHistoryIndex<termHistory.length-1)termIn.value=termHistory[++termHistoryIndex]||'';else{termHistoryIndex=termHistory.length;termIn.value='';}}});

    window.addEventListener('keydown',(e)=>{const isPaletteOpen=overlay.classList.contains('show');if(isPaletteOpen&&e.key==='Escape'){e.preventDefault();hidePalette();return;}if(e.ctrlKey&&e.shiftKey&&e.key.toLowerCase()==='p'){e.preventDefault();showPalette('commands');return;}if(e.ctrlKey&&!e.shiftKey&&e.key.toLowerCase()==='p'){e.preventDefault();showPalette('files');return;}if(e.ctrlKey&&e.key.toLowerCase()==='b'){e.preventDefault();wb.classList.toggle('hide-sidebar');syncToggleButtons();refreshEditorSoon();return;}if(e.ctrlKey&&e.key==='`'){e.preventDefault();wb.classList.toggle('hide-panel');syncToggleButtons();refreshEditorSoon();return;}});
    window.addEventListener('resize', refreshEditorSoon);

    // Auxiliary bar resizer + persistence
    (function setupAuxiliarySizer(){
      const root = document.documentElement;
      const LS_KEY = 'auxiliary-w';
      try {
        const saved = localStorage.getItem(LS_KEY);
        if (saved) root.style.setProperty('--auxiliary-w', saved);
      } catch {}
      let startX=0, startW=0, dragging=false;
      auxResizer.addEventListener('mousedown', (e)=>{
        dragging=true; startX=e.clientX;
        const cs=getComputedStyle(root).getPropertyValue('--auxiliary-w').trim();
        startW=parseInt(cs,10)||360;
        document.body.style.userSelect='none';
      });
      window.addEventListener('mousemove',(e)=>{
        if(!dragging)return;
        const dx=e.clientX - startX;
        const newW=Math.max(220, Math.min(640, startW - dx));
        root.style.setProperty('--auxiliary-w', newW+'px');
        // refresh during drag to avoid visual lag
        refreshEditorSoon();
      });
      window.addEventListener('mouseup',()=>{
        if(!dragging)return; dragging=false; document.body.style.userSelect='';
        try { localStorage.setItem(LS_KEY, getComputedStyle(root).getPropertyValue('--auxiliary-w').trim()); } catch {}
        refreshEditorSoon();
      });
    })();

    // Terminal panel resizer (thin splitter, no persistence)
    (function setupPanelSizer(){
      if (!panelResizer || !contentEl) return;
      const root = document.documentElement;
      let dragging = false;
      let bottom = 0;
      const minH = 120; // keep terminal usable
      let maxH = 520;

      function recompute() {
        const r = contentEl.getBoundingClientRect();
        bottom = r.bottom;
        // don't let the panel take more than ~75% of the work area
        maxH = Math.max(minH, Math.floor(r.height * 0.75));
      }

      function setH(px) {
        const v = Math.max(minH, Math.min(maxH, Math.round(px)));
        root.style.setProperty('--panel-h', v + 'px');
        refreshEditorSoon();
      }

      panelResizer.addEventListener('mousedown', (e)=>{
        if (wb.classList.contains('hide-panel')) return;
        dragging = true;
        recompute();
        document.body.style.userSelect = 'none';
        document.body.style.cursor = 'row-resize';
        e.preventDefault();
      });

      window.addEventListener('mousemove', (e)=>{
        if (!dragging) return;
        setH(bottom - e.clientY);
      });

      window.addEventListener('mouseup', ()=>{
        if (!dragging) return;
        dragging = false;
        document.body.style.userSelect = '';
        document.body.style.cursor = '';
      });

      window.addEventListener('resize', ()=>{ if (dragging) recompute(); });
    })();

    // Refresh when the editor area resizes due to layout changes
    try {
      const ro = new ResizeObserver(()=>refreshEditorSoon());
      ro.observe(editor);
    } catch {}

    // Minimal chat echo
    function syncAuxEmptyState() {
      if (!auxEmptyState || !chatLog) return;
      const hasMessages = chatLog.querySelectorAll('.msg').length > 0;
      auxEmptyState.classList.toggle('visible', !hasMessages);
    }
    function chatPost(role, text) {
      const div=document.createElement('div');
      div.className=`msg ${role}`;
      div.textContent=text;
      chatLog.appendChild(div);
      chatLog.scrollTop=chatLog.scrollHeight;
      syncAuxEmptyState();
    }
    document.getElementById('chatSend').onclick=()=>{
      const q=chatInput.value.trim(); if(!q) return;
      chatPost('user', q);
      chatInput.value='';
      setTimeout(()=>chatPost('bot', 'Echo: '+q), 200);
    };
    chatInput?.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); document.getElementById('chatSend').click(); }});
    syncAuxEmptyState();

    // Workbench theme mapper
    function applyWorkbenchTheme(c) {
      function isUsableColor(v) {
        if (!v) return false;
        const s = String(v).trim().toLowerCase();
        if (s === 'transparent') return false;
        // Ignore fully transparent 8-digit hex like #RRGGBB00
        if (/^#[0-9a-f]{8}$/.test(s) && s.endsWith('00')) return false;
        return true;
      }

      const accentCandidates = [
        ['activityBar.activeBorder', c['activityBar.activeBorder']],
        ['activityBarBadge.background', c['activityBarBadge.background']],
        ['badge.background', c['badge.background']],
        ['progressBar.background', c['progressBar.background']],
        ['button.background', c['button.background']],
        ['terminal.ansiYellow', c['terminal.ansiYellow']], // nice warm fallback for Cursor themes
        ['editorWarning.foreground', c['editorWarning.foreground']],
        ['gitDecoration.modifiedResourceForeground', c['gitDecoration.modifiedResourceForeground']],
        ['list.highlightForeground', c['list.highlightForeground']],
        ['tab.activeBorderTop', c['tab.activeBorderTop']],
        ['tab.activeBorder', c['tab.activeBorder']],
        ['foreground', c['foreground']],
      ];

      const picked = accentCandidates.find(([, v]) => isUsableColor(v));
      const accent = picked?.[1];

      // Debug: show what accent we chose and what was available
      try {
        console.groupCollapsed('[vscode-ish] Theme accent selection');
        console.table(accentCandidates.map(([token, value]) => ({
          token,
          value,
          usable: isUsableColor(value),
        })));
        console.log('Picked accent:', accent, 'from', picked?.[0] || '(none)');
        console.groupEnd();
      } catch {}

      const map = [
        ['--titlebar-bg', c['titleBar.activeBackground']],
        ['--titlebar-fg', c['titleBar.activeForeground']],
        ['--activity-bg', c['activityBar.background']],
        ['--activity-fg', c['activityBar.foreground']],
        ['--activity-active-fg', c['activityBar.foreground']],
        ['--sidebar-bg', c['sideBar.background']],
        ['--sidebar-fg', c['sideBar.foreground']],
        ['--editor-bg', c['editor.background']],
        ['--editor-fg', c['editor.foreground']],
        ['--editor-selection-bg', c['editor.selectionBackground']],
        ['--editor-lineHighlight-bg', c['editor.lineHighlightBackground']],
        ['--editor-cursor-fg', c['editorCursor.foreground']],
        ['--editorLineNumber-fg', c['editorLineNumber.foreground']],
        ['--panel-bg', c['panel.background']],
        ['--panel-fg', c['panel.foreground']],
        ['--status-bg', c['statusBar.background']],
        ['--status-fg', c['statusBar.foreground']],
        ['--command-bg', c['commandCenter.background'] || c['titleBar.inactiveBackground']],
        ['--menu-bg', c['menu.background'] || c['editor.background']],
        ['--chatwin-bg', c['editor.background']],
        ['--chatwin-fg', c['foreground']],
        ['--tab-active-bg', c['tab.activeBackground']],
        ['--tab-bg', c['tab.inactiveBackground']],
        ['--tab-fg', c['tab.activeForeground']],
        ['--tab-inactive-fg', c['tab.inactiveForeground']],
        ['--accent', accent],
        ['--border', c['panel.border'] || c['contrastBorder']],
        ['--fg', c['foreground']],
        ['--muted', c['descriptionForeground']],
        ['--list-hover-bg', c['list.hoverBackground']],
        ['--list-activeSelection-bg', c['list.activeSelectionBackground']],
        ['--list-activeSelection-fg', c['list.activeSelectionForeground']],
        ['--list-activeSelection-border', c['list.activeSelectionForeground'] ? `color-mix(in oklab, ${c['list.activeSelectionForeground']} 30%, transparent)` : undefined]
      ];
      const root = document.documentElement;
      for (const [k,v] of map) if (v) root.style.setProperty(k, v);
    }

    // Parse JSONC (strip comments) safely enough for theme files
    function parseJsonc(text) {
      try { return JSON.parse(text); } catch {}
      let out = '', inStr=false, esc=false, block=false, line=false, quote='"';
      for (let i=0;i<text.length;i++) {
        const ch=text[i], nx=text[i+1];
        if (line) { if (ch==='\n'){ line=false; out+=ch; } continue; }
        if (block) { if (ch==='*'&&nx==='/'){ block=false; i++; } continue; }
        if (inStr) {
          out+=ch;
          if (esc) { esc=false; continue; }
          if (ch==='\\') { esc=true; continue; }
          if (ch===quote) { inStr=false; }
          continue;
        }
        if (ch==='/'&&nx==='/'){ line=true; i++; continue; }
        if (ch==='/'&&nx==='*'){ block=true; i++; continue; }
        if (ch==='"' || ch==="'"){ inStr=true; quote=ch; out+=ch; continue; }
        out+=ch;
      }
      return JSON.parse(out);
    }

    // Accept full theme JSON or { "colors": { ... } } or { "workbench.colorCustomizations": { ... } }
    function applyVSCodeThemeObject(obj) {
      try {
        const colors = obj?.colors || obj?.['workbench.colorCustomizations'] || obj || {};
        applyWorkbenchTheme(colors);
        refreshEditorSoon?.();
        setStatus('Theme applied');
      } catch (e) {
        console.error(e);
        setStatus('Theme import failed');
      }
    }

    themeFile.addEventListener('change', async ()=>{
      const file = themeFile.files?.[0]; if(!file) return;
      try {
        const text = await file.text();
        const json = parseJsonc(text);
        applyVSCodeThemeObject(json);
      } catch (e) {
        console.error(e);
        alert('Failed to load theme JSON');
      }
    });

    async function initProject() {
      // Load Seti file icon theme (used by tabs + explorer)
      const themeLoaded = await loadSetiThemeFromAssets();
      if (!themeLoaded) {
        console.error('Failed to load Seti theme - icons will use fallback');
      }
      // Ensure Seti font is loaded before rendering icons
      if ('fonts' in document && setiTheme) {
        try {
          await document.fonts.load('24px seti');
          // Verify font loaded
          const checkFont = await document.fonts.check('24px seti');
          console.log('Seti font loaded:', checkFont);
        } catch (e) {
          console.error('Seti font load check failed:', e);
        }
      }
      // If nothing meaningful persisted, try to seed from bundled example
      if (!savedRaw || savedRaw === '{}' || files.size === 0) {
        await loadDefaultProjectFromAssets();
      }
      // Ensure at least something is present
      if (files.size === 0) {
        files = new Map(Object.entries(defaultFiles));
        saveToStorage();
      }
      // Choose and open initial file
      (function chooseInitialFile(){
        try {
          const get = (n)=> (files.get(n)||'').trim();
          const candidates = ['README.md','readme.md','app.js','index.js','style.css'];
          for (const name of candidates) {
            if (files.has(name) && get(name).length>0) { currentFile = name; return; }
          }
          const first = [...files.keys()][0];
          if (first) currentFile = first;
        } catch {}
      })();
      renderTree();renderTabs();openFile(currentFile);setDirty(false);syncToggleButtons();refreshEditorSoon();
      syncEmptyStateShortcuts();
    termPrint('Terminal ready. Type "help"','term-ok');
      window.addEventListener('load', ()=>refreshEditorSoon());
    }
    initProject();
  </script>
</body>
</html>